# FCM Token Registration Guide

## Overview

Firebase Cloud Messaging (FCM) requires each device to have a unique device token. This token must be sent to the backend after user login so that notifications can be delivered to the correct device.

## Problem Solved

**Previous Error:**
```
FirebaseMessagingError: Exactly one of topic, token or condition is required
```

**Root Cause:** The backend was trying to send notifications using the user ID (35) instead of the actual FCM device token generated by Firebase Messaging SDK on the mobile device.

**Solution:** Implement proper FCM token storage and retrieval system.

---

## Backend Implementation (COMPLETED ‚úÖ)

### 1. Database Schema Change
- **File:** `src/extensions/users-permissions/content-types/user/schema.json`
- **Change:** Added `fcmToken` field to store device tokens
- **Type:** Text (private, optional)

### 2. FCM Token Registration Endpoint
- **Endpoint:** `POST /auth/fcm-token`
- **Authentication:** Required (JWT Bearer token)
- **Request Body:**
  ```json
  {
    "token": "FCM_DEVICE_TOKEN_HERE"
  }
  ```

### 3. Notification Service Updates
- **New Functions:**
  - `getUserFCMToken(userId)` - Fetches stored token from database
  - `sendNotificationToUser(userId, payload)` - Sends notification using stored token

### 4. Updated Notification Triggers
All notification functions now use `sendNotificationToUser(user.id, payload)` instead of incorrectly passing user ID as token.

---

## Mobile App Implementation (TODO)

### For Dart/Flutter App (gbrain-app)

#### 1. After Successful Login

In your login controller/provider, after the JWT token is received:

```dart
// In your login/auth flow after successful authentication
Future<void> registerFCMToken() async {
  try {
    // Get the FCM token
    final notificationService = ref.read(firebaseNotificationServiceProvider);
    final fcmToken = await notificationService.getFCMToken();
    
    if (fcmToken != null) {
      // Get the JWT token from secure storage or auth state
      final jwtToken = await secureStorage.read(key: 'jwt_token');
      
      // Send token to backend
      final response = await http.post(
        Uri.parse('${ApiConstants.baseUrl}/auth/fcm-token'),
        headers: {
          'Authorization': 'Bearer $jwtToken',
          'Content-Type': 'application/json',
        },
        body: jsonEncode({
          'token': fcmToken,
        }),
      );
      
      if (response.statusCode == 200) {
        print('‚úÖ FCM token registered successfully');
      } else {
        print('‚ùå Failed to register FCM token: ${response.statusCode}');
      }
    }
  } catch (e) {
    print('‚ùå Error registering FCM token: $e');
    // Don't block login if FCM registration fails
  }
}
```

#### 2. Call After Every Login

```dart
// In your login success callback
await mobileLogin();  // Existing login function
await registerFCMToken();  // Add this after login
```

#### 3. Consider Token Refresh

If the FCM token changes (app reinstall, token refresh):

```dart
// Monitor FCM token changes
FirebaseMessaging.instance.onTokenRefresh.listen((newToken) {
  // Register new token with backend
  registerFCMToken();
});
```

#### 4. Handle App Startup

For already-logged-in users, register token on app startup:

```dart
// In your app initialization/splash screen
Future<void> initializeApp() async {
  final authToken = await secureStorage.read(key: 'jwt_token');
  
  if (authToken != null) {
    // User is already logged in
    await registerFCMToken();
  }
}
```

---

## Testing the Implementation

### Step 1: Verify Backend Deployment
```bash
# Check logs for Firebase initialization
# Should see: ‚úÖ Firebase Admin SDK initialized successfully
```

### Step 2: Test FCM Token Endpoint (Manual)
```bash
# Get a valid JWT token from login
POST /auth/fcm-token
Authorization: Bearer YOUR_JWT_TOKEN
Content-Type: application/json

{
  "token": "eIfFyJM8sF8:APA91bE1a2b3c..."
}

# Expected Response:
{
  "message": "FCM token saved successfully",
  "success": true
}
```

### Step 3: Verify Token Stored
```bash
# Check database
SELECT fcmToken FROM up_users WHERE id = 1;
# Should show the FCM token
```

### Step 4: Test Notification Sending
1. Deploy updated mobile app
2. User logs in
3. App registers FCM token
4. User performs a transaction (airtime, electricity, etc.)
5. Check device for notification
6. Check backend logs for success message

---

## API Response Codes

| Code | Meaning | Action |
|------|---------|--------|
| 200 | Success | Token registered, proceed normally |
| 400 | Bad Request | Check token format, must be non-empty string |
| 401 | Unauthorized | JWT token invalid or expired, re-login |
| 500 | Server Error | Backend issue, retry later |

---

## Error Handling

### What Happens if Token Registration Fails?

1. **Non-Blocking:** Login succeeds even if FCM token registration fails
2. **Logged:** Error is logged for debugging
3. **Retry:** Next login will attempt to register token again
4. **Graceful:** Notifications won't send until token is registered, but app still works

### What Happens if User Has No Token?

1. **Warning Logged:** "No FCM token found for user X"
2. **Notification Skipped:** Notification silently fails to send
3. **Transaction Succeeds:** Payment/transaction completes normally
4. **No User Impact:** User's app won't crash

---

## Notification Flow After Fix

```
Mobile App Login
    ‚Üì
Request FCM Token from Firebase Messaging SDK
    ‚Üì
Receive Token (e.g., "eIfFyJM8sF8:APA91bE...")
    ‚Üì
POST /auth/fcm-token with token
    ‚Üì
Backend Stores Token in Database (user.fcmToken)
    ‚Üì
User Performs Transaction (airtime, etc.)
    ‚Üì
Backend Sends Notification:
  - Calls sendPaymentSuccessNotification(user, ...)
  - Calls sendNotificationToUser(user.id, payload)
  - getUserFCMToken() fetches token from database
  - sendNotificationToToken(token, payload) sends to Firebase
    ‚Üì
Firebase Cloud Messaging Routes to Correct Device
    ‚Üì
Device Receives Notification
    ‚Üì
Notification Displayed to User ‚úÖ
```

---

## Environment Variables (Backend)

Already configured:
- `FIREBASE_PROJECT_ID=fendur-57f58`
- `FIREBASE_SERVICE_ACCOUNT_KEY=...` (JSON with credentials)

These are required for the backend to initialize Firebase Admin SDK.

---

## Debugging Tips

### Enable Debug Logging

In notification-service.js, messages are logged with emojis:
- ‚úÖ = Success
- ‚ùå = Error
- ‚ö†Ô∏è = Warning
- üì§ = Sending notification

### Check Database

```sql
-- See FCM tokens for all users
SELECT id, email, fcmToken FROM up_users WHERE fcmToken IS NOT NULL;

-- Check specific user
SELECT fcmToken FROM up_users WHERE id = 35;

-- Clear token for testing (dev only!)
UPDATE up_users SET fcmToken = NULL WHERE id = 35;
```

### Check Firebase Logs

1. Go to Firebase Console
2. Project: fendur-57f58
3. Check Cloud Messaging section for delivery reports

---

## Migration Notes

**Breaking Changes:** None. The system gracefully handles missing tokens.

**Data Migration:** No existing data needs to be migrated. Tokens are set on first login after update.

**Backward Compatibility:** Old versions of app that don't register tokens will simply not receive notifications until updated.

---

## Production Checklist

- [x] Backend code deployed
- [ ] Mobile app updated with FCM token registration
- [ ] Database schema migrated
- [ ] Firebase initialized successfully (check logs)
- [ ] FCM tokens being stored in database
- [ ] Notifications delivering successfully
- [ ] Error logging in place
- [ ] User feedback mechanism in place

---

## Questions?

Refer to the implementation files:
- Backend: `src/utils/firebase/notification-service.js`
- Triggers: `src/utils/notification-triggers.js`
- Routes: `src/extensions/users-permissions/server/routes/content-api/auth.js`
- Controller: `src/extensions/users-permissions/server/controllers/auth.js`
